generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mongodb"
  relationMode = "prisma"
}

// ============================================
// Enums
// ============================================
enum UserRole {
  ADMIN
  STUDENT
}

enum TestStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

// ============================================
// User Model (Clerk Integration)
// ============================================
model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String   @unique
  name         String?
  clerkId      String   @unique
  role         UserRole @default(STUDENT)
  avatarUrl    String?
  grade        Int? // For students
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastActiveAt DateTime @default(now())

  // Relations
  createdTests       Test[]               @relation("TestCreator")
  uploadedLessons    Lesson[]             @relation("LessonUploader")
  testAttempts       TestAttempt[]        @relation("StudentAttempts")
  performanceMetrics PerformanceMetrics[] @relation("StudentMetrics")

  @@map("users")
}

// ============================================
// Lesson Model (Uploaded Documents)
// ============================================
model Lesson {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  fileName    String
  fileUrl     String
  fileType    String
  uploadedAt  DateTime @default(now())
  uploadedBy  String   @db.ObjectId

  // Relations
  uploader User   @relation("LessonUploader", fields: [uploadedBy], references: [id])
  tests    Test[] @relation("LessonTests")

  @@map("lessons")
}

// ============================================
// Test Model
// ============================================
model Test {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  description   String
  scheduledDate DateTime
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  createdBy     String     @db.ObjectId
  status        TestStatus @default(DRAFT)
  questionCount Int        @default(0)
  duration      Int // in minutes
  lessonId      String?    @db.ObjectId

  // Relations
  creator      User          @relation("TestCreator", fields: [createdBy], references: [id])
  lesson       Lesson?       @relation("LessonTests", fields: [lessonId], references: [id])
  questions    Question[]    @relation("TestQuestions")
  testAttempts TestAttempt[] @relation("TestAttempts")

  @@map("tests")
}

// ============================================
// Question Model
// ============================================
model Question {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  testId        String   @db.ObjectId
  questionText  String // Contains __BLANK__ placeholder
  correctAnswer String
  hints         String[] // Array of hint strings
  microLearning String // AI-generated explanation for kids
  order         Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Mastery-Based Learning Config
  maxAttemptsBeforeStudy Int @default(4) // 1 initial + 3 hints, then must study

  // Relations
  test             Test              @relation("TestQuestions", fields: [testId], references: [id], onDelete: Cascade)
  questionAttempts QuestionAttempt[] @relation("QuestionAttempts")

  @@map("questions")
}

// ============================================
// Test Attempt Model
// ============================================
model TestAttempt {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  testId      String        @db.ObjectId
  studentId   String        @db.ObjectId
  startedAt   DateTime      @default(now())
  completedAt DateTime?
  status      AttemptStatus @default(IN_PROGRESS)

  // Dual Scoring System
  basicScore       Float? // Simple correctness: (correct/total) * 100
  aiScore          Float? // Advanced behavioral analysis score (0-100)
  aiScoreBreakdown Json? // Detailed breakdown: {correctness: 40, timeEfficiency: 15, engagement: 20, hintIndependence: 15, firstAttempt: 10}

  // Basic Metrics
  totalQuestions   Int
  correctAnswers   Int  @default(0)
  hintsUsed        Int  @default(0)
  timeTakenSeconds Int?

  // Behavioral Analytics
  learningEngagementRate  Float? // Percentage of micro-learning content viewed
  averageTimePerQuestion  Float? // Average seconds per question
  firstAttemptSuccessRate Float? // Percentage of questions correct on first try
  hintDependencyRate      Float? // Percentage of questions requiring hints
  persistenceScore        Float? // Based on retry patterns and completion
  confidenceIndicator     Float? // Based on speed + correctness correlation

  // Mastery-Based Learning
  forcedStudyBreaks       Int     @default(0) // Times student had to download material
  masteryAchieved         Boolean @default(false) // All questions answered correctly
  questionsRequiringStudy Int     @default(0) // Questions that needed material download

  // Relations
  test             Test              @relation("TestAttempts", fields: [testId], references: [id])
  student          User              @relation("StudentAttempts", fields: [studentId], references: [id])
  questionAttempts QuestionAttempt[] @relation("AttemptQuestions")

  @@map("test_attempts")
}

// ============================================
// Question Attempt Model
// ============================================
model QuestionAttempt {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  attemptId     String   @db.ObjectId
  questionId    String   @db.ObjectId
  studentAnswer String
  isCorrect     Boolean
  attemptsCount Int      @default(1)
  createdAt     DateTime @default(now())

  // Time Tracking
  timeTakenSeconds       Int // Total time on this question
  timeBeforeFirstAttempt Int? // Thinking time before first answer

  // Hint Usage Tracking
  hintsUsed        Int   @default(0)
  hintSequence     Int[] // Array of hint indices used (e.g., [0, 1, 2])
  timeSpentOnHints Int? // Total seconds viewing hints

  // Micro-Learning Tracking
  viewedMicroLearning       Boolean @default(false)
  microLearningViewedBefore Boolean @default(false) // Viewed before or after answering
  microLearningTimeSpent    Int? // Seconds spent on micro-learning

  // Behavioral Indicators
  answeredOnFirstAttempt Boolean @default(false) // Got it right first try
  usedNoHints            Boolean @default(true) // Solved without hints
  showedPersistence      Boolean @default(false) // Multiple attempts before success

  // Mastery-Based Learning
  studyMaterialDownloaded Boolean   @default(false) // Downloaded lesson after failing
  downloadedAt            DateTime? // When student downloaded study material
  retriesAfterStudy       Int       @default(0) // Attempts after downloading material
  mustStudyBeforeRetry    Boolean   @default(false) // Blocked until downloads material

  // Relations
  testAttempt TestAttempt @relation("AttemptQuestions", fields: [attemptId], references: [id], onDelete: Cascade)
  question    Question    @relation("QuestionAttempts", fields: [questionId], references: [id])

  @@map("question_attempts")
}

// ============================================
// Performance Metrics Model (Aggregate Analytics)
// ============================================
model PerformanceMetrics {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  studentId String  @db.ObjectId
  testId    String? @db.ObjectId

  averageBasicScore         Float
  averageAiScore            Float
  totalAttempts             Int
  improvementRate           Float
  consistencyScore          Float
  averageHintUsage          Float
  averageLearningEngagement Float
  averageTimeEfficiency     Float
  strongTopics              String[]
  weakTopics                String[]
  calculatedAt              DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  student User @relation("StudentMetrics", fields: [studentId], references: [id])

  @@map("performance_metrics")
}
